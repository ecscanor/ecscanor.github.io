<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>自走車 MQTT 控制按鈕</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <h1>自走車目的地控制</h1>

  <!-- 連線按鈕 -->
  <button id="connectBtn">連線到 MQTT</button>
  <div id="connStatus">尚未連線</div>

  <h2>選擇目的地</h2>
  <!-- 全部系館按鈕 -->
  <div id="buttons">
    <button onclick="sendDest('工學館')">工學館</button>
    <button onclick="sendDest('土木館')">土木館</button>
    <button onclick="sendDest('科學館')">科學館</button>
    <button onclick="sendDest('理學大樓')">理學大樓</button>
    <button onclick="sendDest('化學館')">化學館</button>
    <button onclick="sendDest('資管樓')">資管樓</button>
    <button onclick="sendDest('商學院')">商學院</button>
    <button onclick="sendDest('商設館')">商設館</button>
    <button onclick="sendDest('工學院')">工學院</button>
    <button onclick="sendDest('工工館')">工工館</button>
    <button onclick="sendDest('設計系')">設計系</button>
    <button onclick="sendDest('電子大樓')">電子大樓</button>
    <button onclick="sendDest('維澈樓')">維澈樓</button>
    <button onclick="sendDest('懷恩樓')">懷恩樓</button>
    <button onclick="sendDest('圖書館')">圖書館</button>
  </div>

  <h2>車輛狀態</h2>
  <div id="statusLog" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: scroll;"></div>

<script>
  let client = null;

  const options = {
    username: "bensonlu",
    password: "91827346zA",
    clean: true,
    connectTimeout: 4000,
    reconnectPeriod: 1000,
  };

  document.getElementById("connectBtn").onclick = () => {
    if (client && client.connected) {
      client.end();
      document.getElementById("connStatus").innerText = "已斷線";
      client = null;
      return;
    }

    client = mqtt.connect("wss://8cc20f86cef54ccb8d2efb0cc0c45607.s1.eu.hivemq.cloud:8884/mqtt", options);

    client.on("connect", () => {
      document.getElementById("connStatus").innerText = "已連線";
      client.subscribe("car/status");
    });

    client.on("reconnect", () => {
      document.getElementById("connStatus").innerText = "重新連線中...";
    });

    client.on("error", (err) => {
      document.getElementById("connStatus").innerText = "連線錯誤：" + err.message;
    });

    client.on("message", (topic, message) => {
      if (topic === "car/status") {
        let log = document.getElementById("statusLog");
        log.innerText = `[${new Date().toLocaleTimeString()}] ${message.toString()}\n` + log.innerText;
      }
    });
  };

  function sendDest(dest) {
    if (!client || !client.connected) {
      alert("請先連線到 MQTT Broker");
      return;
    }
    // 發送純字串，符合 Python 端的 msg.payload.decode('utf-8')
    client.publish("car/control", dest);
    alert("已發送目的地：" + dest);
  }
</script>

</body>
</html>
